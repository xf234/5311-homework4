<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3 Bubble Chart with Search</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    #information {
      position: fixed;
      top: 30px;
      right: 40px;
      width: 500px;
      height: 150px;
      border: solid 1px red;
    }

    #barTitle {
      position: fixed;
      top: 200px;
      right: 120px;    
    }

    .y.axis path,
    .y.axis line {
            fill: none;
            stroke: none;
    }

    .bar.positive {
      fill: #D5F7DA;
    }

    .bar.negative {
      fill: #FFD79B;
    }
    
  </style>
</head>

<body>
  <p>1. change button content <br>
  2. find picture, make the bar chart longer <br>
  3. dinamically change bubble chart length <br>
  4. start css style <br>
  4.1 add title and explanation <br>
  4.2 change font <br>
  4.3 style seach bar and button <br>
  4.4 debug drag <br>
  5. finish report
  </p>
  <div>
    <a href="../../5311-homework1/static/index.html">go to future</a>
    <input type="text" id="searchInput" placeholder="Search by name">
    <button id="sortButton">Sort Circles</button>
  </div>


  <svg width="900" height="1800" id="bubbleChart" style="border: solid 1px black;"></svg>
  <div id="information">
    <h4>Hover to see Candy Information</h4>
    <table>
    
      <tbody>
          <tr>
              <td>Candy Name:</td>
              <td id="candyName"></td>
          
          </tr>
          <tr>
              <td>Win Percent:</td>
              <td id="winPercent"></td>
             
          </tr>
          <tr>
              <td>Sugar Percent:</td>
              <td id="sugarPercent"></td>
         
          </tr>
      </tbody>
  </table>
  </div>
  <p id="barTitle">How much win percentage of a candy brand will rise <br>if it is one of the following types</p>
  <svg width="500" height="500" id="barChart" style="border: solid 1px black; position:fixed;top: 200;
      right: 40;"></svg>



  <script>
    const layer = d3.select("#bubbleChart").append("g");
    const width = d3.select("#bubbleChart").attr("width");
    const height = d3.select("#bubbleChart").attr("height");
    console.log(width, height);

    const searchInput = document.getElementById('searchInput');
    const sortButton = document.getElementById('sortButton');

    var whetherSort = false;

    const svgBar = d3.select("#barChart");
    const marginBar = { top: 70, right: 40, bottom: 20, left: 120 };
    const widthBar = svgBar.attr("width");
    const heightBar = svgBar.attr("height");
    const chartWidth = widthBar - marginBar.left - marginBar.right;
    const chartHeight = heightBar - marginBar.top - marginBar.bottom;
    const chartArea = svgBar.append("g")
      .attr("transform", "translate(" + marginBar.left + "," + marginBar.top + ")");

    const requestData = async function () {
      const candies = await d3.json("data/candy_data.json");
      console.log(candies);
      const types = await d3.json("data/type_win.json");
      console.log(types);

      const colorScale = d3.scaleQuantile()
        .domain(candies.map(d => d.winpercent))
        .range(["#FFF8E1", "#FFCEA3", "#FEC100", "#FF9234"]);

      const radiusExtent = d3.extent(candies, d => d['winpercent']);
      const radiusScale = d3.scaleLinear().domain(radiusExtent).range([25, 50]);

      var forceNormal = d3.forceY(width / 2 + 50).strength(0.05);
      var forceSort = d3.forceY(function (d) {
        let color = colorScale(d.winpercent);
        if (color === "#FFF8E1") {
          return 1600;
        } else if (color === "#FFCEA3") {
          return 1180;
        } else if (color === "#FEC100") {
          return 780;
        } else {
          return 300;
        }
      }).strength(0.05);

      const simulation = d3.forceSimulation(candies)
        .force("x", d3.forceX(width / 2).strength(0.05))
        .force("y", forceNormal)
        .force("collide", d3.forceCollide(d => radiusScale(d.winpercent) + 5))
        .on("tick", render);

      function render() {

        const circles = layer.selectAll("circle.bubble").data(candies)
          .join(
            enter => enter.append("circle")
              .attr("class", "bubble")
              .attr("r", d => radiusScale(d.winpercent))
              .attr("cx", 0)
              .attr("cy", 0)
              .attr("fill", d => colorScale(d.winpercent))
              .attr('opacity', 0.8)
              .on("mouseover", show_details)
              .on("mouseout", remove_details)
              .call(d3.drag().on("start", dragstart)
                .on("drag", dragging)
                .on("end", dragend))
          )
          .attr("transform", d => `translate(${d.x},${d.y})`)
          ;

        const labels = layer.selectAll("text.label")
          .data(candies)
          .join("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")
          .style("font-size", "10px")
          .text(d => d.competitorname.length > 15 ? d.competitorname.substring(0, 10) + '...' : d.competitorname)
          .attr("transform", d => `translate(${d.x},${d.y})`)
          .on("mouseover", show_details);

        searchInput.addEventListener('input', function () {
          const searchText = this.value.trim().toLowerCase();
          circles.attr('display', d => d.competitorname.toLowerCase().includes(searchText) ? 'block' : 'none');
          labels.attr('display', d => d.competitorname.toLowerCase().includes(searchText) ? 'block' : 'none');
        });
      }

      render();

      d3.select("#sortButton").on('click', function () {
        if (whetherSort == false) {
          simulation
            .force('y', forceSort)
            .alphaTarget(0.5)
            .restart()
          whetherSort = true;
        } else {

          simulation
            .force('y', forceNormal)
            .alphaTarget(0.08)
            .restart()
          whetherSort = false;
        }
      }
      );

      ///////////////////////////////////////////////////////////////////////////////////

      let typeScale = d3.scaleBand()
        .domain(types.map(d => d.type))
        .range([0, chartHeight])
        .padding(0.4);

      let valueScale = d3.scaleLinear()
        .domain([d3.min(types, d => Math.min(d.number, 0)), d3.max(types, d => Math.max(d.number, 0))])
        .range([0, chartWidth]);

      let leftAxis = d3.axisLeft(typeScale);
      svgBar.append('g')
        .attr('class', 'y axis')
        .attr('transform', `translate(${marginBar.left - 30},${marginBar.top})`)
        .call(leftAxis);

      chartArea.selectAll(".bar")
        .data(types)
        .enter().append("rect")
        .attr("class", d => "bar " + (d.number < 0 ? "negative" : "positive"))
        .attr("x", d => (d.number < 0 ? valueScale(d.number) : valueScale(0)))
        .attr("y", d => typeScale(d.type))
        .attr("width", d => Math.abs(valueScale(0) - valueScale(d.number)))
        .attr("height", typeScale.bandwidth());

      chartArea.selectAll(".bar-label")
        .data(types, d => d.number)
        .enter()
        .append("text")
        .attr("class", "bar-label")
        .attr("x", d => (d.number < 0 ? valueScale(d.number) - 35 : valueScale(d.number)) + 5)
        .attr("y", d => typeScale(d.type) + typeScale.bandwidth() / 2)
        .text(d => d.number + "%")
        .attr("alignment-baseline", "middle")
        .attr("font-size", "12px")
        .attr("font-family", "Roboto");

      function dragstart(event, d) {
        if (!event.active) {
          simulation.alphaTarget(0.08).restart();
        }

        d.fx = event.x;
        d.fy = event.y;
      }

      function dragging(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragend(event, d) {

        if (!event.active) {
          simulation.alphaTarget(0);
        }
        d.fx = null;
        d.fy = null;
      }

      function show_details(d) {

        d3.select("#candyName")
          .text(d.competitorname);
        d3.select("#winPercent")
          .text(d.winpercent);
        d3.select("#sugarPercent")
          .text(d.sugarpercent);

        ingredients = d.ingredients;
        console.log(ingredients);

        if (ingredients.length > 0){
          console.log("have ingredients",);
          d3.selectAll(".bar")
            .filter(barData => {
              console.log(barData.type, ingredients, ingredients.includes(barData.type));
              return ingredients.includes(barData.label)})
            .style("fill", barData => barData.number < 0 ? "#FFAE34" : "#78DD87");
        }

      }

      function remove_details() {
        d3.select("#candyName")
          .text("");
        d3.select("#winPercent")
          .text("");
        d3.select("#sugarPercent")
          .text("");

        d3.select("#barChart").selectAll(".bar.positive")
          .style("fill", "#D5F7DA");

        d3.select("#barChart").selectAll(".bar.negative")
          .style("fill", "#FFD79B");
      }
    }

    requestData();


  </script>

</body>

</html>